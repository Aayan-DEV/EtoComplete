{% load static %}
<!DOCTYPE html>
<html lang="en" class="min-h-full">
  <head>
    <meta charset="utf-8" />
    <title>Eto — Bulk Product Research</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['OpenSauce', 'ui-sans-serif', 'system-ui', '-apple-system', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'Noto Sans', 'sans-serif']
            },
            colors: {
              panel: '#ffffff',
              border: 'rgba(0,0,0,0.12)',
            }
          }
        }
      };
    </script>
    <style>
      @font-face {
        font-family: "OpenSauce";
        src: url("{% static 'font/open_sauce/OpenSauceSans-Regular.ttf' %}") format("truetype");
        font-display: swap;
      }
      html, body { font-family: "OpenSauce", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
    </style>
    <link rel="stylesheet" href="{% static 'users_dasboard/bulk_research/bulk_research.css' %}">
  </head>
  <body class="min-h-screen bg-[var(--bg)] text-[var(--text)]">
    {% include "snippets/message_alerts/messages.html" %}

    <main class="min-h-screen grid grid-cols-[16rem_1fr]">
      {% include "snippets/sidebar/sidebar.html" %}
      <section class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="flex items-center justify-between px-6 py-4 border-b border-[var(--border)] bg-[var(--surface-1)]">
          <h1 class="text-xl tracking-tight">Bulk Product Research</h1>
          <div class="flex items-center gap-3">
            <button id="sessions-button" class="inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm border border-[var(--border)] bg-[var(--surface-1)] text-[var(--text)] hover:bg-[var(--surface-2)]">
              <span>Sessions</span>
              <svg class="h-4 w-4 opacity-70" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 0 1 1.06-.02L10 10.67l3.71-3.48a.75.75 0 0 1 1.04 1.08l-4.23 3.97a1 1 0 0 1-1.38 0L5.25 8.27a.75.75 0 0 1-.02-1.06Z"/></svg>
            </button>

            <div class="relative">
              <button id="user-toggle" class="inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm border border-[var(--border)] bg-[var(--surface-1)] text-[var(--text)]">
                <span>{{ request.user.get_full_name|default:request.user.username }}</span>
                <svg class="h-4 w-4 opacity-70" viewBox="0 0 20 20" fill="currentColor"><path d="M5.23 7.21a.75.75 0 0 1 1.06-.02L10 10.67l3.71-3.48a.75.75 0 0 1 1.04 1.08l-4.23 3.97a1 1 0 0 1-1.38 0L5.25 8.27a.75.75 0 0 1-.02-1.06Z"/></svg>
              </button>
              <div id="user-panel" class="absolute right-0 mt-2 w-72 rounded-xl bg-[var(--surface-1)] border border-[var(--border)] shadow-sm hidden text-[var(--text)]">
                <div class="px-4 py-3 text-sm">
                  <div class="flex items-center justify-between"><span class="text-neutral-500">Email</span><span class="font-medium">{{ request.user.email }}</span></div>
                  <div class="mt-2 flex items-center justify-between"><span class="text-neutral-500">Confirmed</span><span class="font-medium">{% if request.user.profile and request.user.profile.email_confirmed %}Yes{% else %}No{% endif %}</span></div>
                  <div class="mt-2 flex items-center justify-between"><span class="text-neutral-500">Joined</span><span class="font-medium">{{ request.user.date_joined|date:"M j, Y" }}</span></div>
                </div>
                <div class="px-4 py-3 border-t border-[var(--border)]">
                  <a href="{% url 'logout' %}" class="inline-flex w-full items-center justify-center rounded-lg px-3 py-2 text-sm border border-[var(--border)] hover:bg-[var(--surface-2)]">Sign out</a>
                </div>
              </div>
            </div>
          </div>
        </header>

        <!-- Main -->
        <div class="flex-1 px-6 py-6">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <h2 id="results-title" class="text-lg font-medium">No session selected</h2>
              <div id="results-loading" class="loading-icon hidden" aria-label="Loading" title="Loading"></div>
              <button id="results-back" class="hidden inline-flex items-center rounded-lg px-3 py-1.5 text-sm border border-[var(--border)] bg-[var(--surface-1)] hover:bg-[var(--surface-2)]">
                Back to results
              </button>
            </div>
            <div class="flex items-center gap-2">
              <label for="results-session-select" class="text-sm text-[var(--muted)]">Session</label>
              <select id="results-session-select" class="rounded-md border border-neutral-300 bg-white px-2 py-1 text-sm">
                <option value="" selected>Select...</option>
                <option value="__all__">All Sessions</option>
              </select>
            </div>
          </div>

          <section id="results-panel" class="mt-4">
            <!-- Sort / Filter Bar -->
            <div id="filter-bar" class="flex items-center gap-2 rounded-lg border border-[var(--border)] bg-[var(--surface-1)] px-3 py-2">
              <span class="text-sm text-[var(--muted)]">Sort</span>

              <!-- Metric dropdown -->
              <select id="sort-metric-select" class="rounded-md border border-neutral-300 bg-white text-black px-2 py-1 text-sm">
                <option value="price">Price</option>
                <option value="demand" selected>Demand</option>
              </select>

              <!-- Order dropdown -->
              <select id="sort-order-select" class="rounded-md border border-neutral-300 bg-white text-black px-2 py-1 text-sm">
                <option value="desc" selected>High → Low</option>
                <option value="asc">Low → High</option>
              </select>
            </div>

            <!-- Products Grid -->
            <div id="products-grid" class="products-grid mt-4"></div>
          </section>
    </main>

    <!-- Sessions panel -->
    <div id="sessions-panel" class="sessions-panel hidden">
      <div class="sessions-card">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-medium">Sessions</h3>
          <button id="sessions-close" class="inline-flex items-center justify-center rounded-lg px-3 py-2 text-sm border border-neutral-200 bg-white hover:bg-neutral-50">Close</button>
        </div>

        <div class="mt-3">
          <button id="add-session-btn" class="inline-flex items-center justify-center rounded-lg px-3 py-2 text-sm border border-neutral-200 bg-white hover:bg-neutral-50">Add Session</button>
        </div>

        <div id="sessions-list" class="mt-4 sessions-list"></div>
      </div>
    </div>

    <!-- Wizard -->
    <div id="wizard" class="wizard hidden">
      <div class="wizard-card">
        <button id="wizard-close" class="wizard-close" aria-label="Close">
          <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M5.22 5.22a.75.75 0 0 1 1.06 0L10 8.94l3.72-3.72a.75.75 0 1 1 1.06 1.06L11.06 10l3.72 3.72a.75.75 0 1 1-1.06 1.06L10 11.06l-3.72 3.72a.75.75 0 1 1-1.06-1.06L8.94 10 5.22 6.28a.75.75 0 0 1 0-1.06Z"/></svg>
        </button>

        <div class="wizard-step" data-step="1">
          <h3 class="text-xl">Write your keyword</h3>
          <input id="keyword-input" type="text" class="wizard-input" placeholder="e.g. christmas" />
          <div class="wizard-actions">
            <button id="step1-next" class="btn-primary">Next</button>
          </div>
        </div>

        <div class="wizard-step hidden" data-step="2">
          <h3 class="text-xl">Amount of products</h3>
          <input id="total-input" type="number" min="1" step="1" class="wizard-input" placeholder="e.g. 50" />
          <div class="wizard-actions">
            <button id="step2-done" class="btn-primary">Done</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      window.BULK_RESEARCH_START_URL = "{% url 'bulk_research_start' %}";
      window.BULK_RESEARCH_STREAM_URL_BASE = "/api/bulk-research/stream/";
      window.BULK_RESEARCH_RESULT_URL_BASE = "/api/bulk-research/result/";
      window.BULK_RESEARCH_LIST_URL = "/api/bulk-research/list/";
      window.CSRF_TOKEN = (function(){
        function getCookie(name) {
          var value = '; ' + document.cookie;
          var parts = value.split('; ' + name + '=');
          if (parts.length === 2) return parts.pop().split(';').shift();
          return null;
        }
        return getCookie('csrftoken');
      })();
      window.INITIAL_SESSIONS = JSON.parse('{{ sessions_json|default:"[]"|escapejs }}');
    </script>
    <script src="{% static 'users_dasboard/bulk_research/bulk_research.js' %}"></script>
  </body>
</html>