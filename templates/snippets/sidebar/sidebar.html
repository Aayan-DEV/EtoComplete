{% load static %}
<aside class="flex h-screen w-64 shrink-0 flex-col bg-[var(--surface-1)] ring-1 ring-[var(--border)] sticky top-0">
  <nav class="flex-1 px-3 py-4 space-y-1 text-sm overflow-y-auto">
    {% url 'users_main_dash' as dashboard_url %}
    {% url 'users_va_admin' as va_admin_url %}
    {% url 'users_customer_support' as support_url %}
    {% url 'users_single_research' as single_url %}
    {% url 'users_bulk_research' as bulk_url %}
    {% url 'users_keyword_search' as keywords_url %}
    {% url 'users_settings' as settings_url %}

    <!-- Dashboard -->
    <a href="{{ dashboard_url }}"
       class="group flex items-center gap-3 rounded-lg px-3 py-2 transition
              {% if request.path == dashboard_url %} bg-white/10 text-white {% else %} text-white/70 hover:text-white hover:bg-white/5 {% endif %}"
       aria-current="{% if request.path == dashboard_url %}page{% else %}false{% endif %}">
      <svg class="h-4 w-4 opacity-80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="3" y="3" width="8" height="8" rx="2"></rect>
        <rect x="13" y="3" width="8" height="8" rx="2"></rect>
        <rect x="13" y="13" width="8" height="8" rx="2"></rect>
        <rect x="3" y="13" width="8" height="8" rx="2"></rect>
      </svg>
      <span class="font-medium">Dashboard</span>
    </a>

    <!-- Manage VA's -->
    <a href="{{ va_admin_url }}"
       class="group flex items-center gap-3 rounded-lg px-3 py-2 transition
              {% if request.path == va_admin_url %} bg-white/10 text-white {% else %} text-white/70 hover:text-white hover:bg-white/5 {% endif %}"
       aria-current="{% if request.path == va_admin_url %}page{% else %}false{% endif %}">
      <svg class="h-4 w-4 opacity-80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <circle cx="8" cy="7.5" r="3"></circle>
        <path d="M3 14c0-2.5 3-4 5-4s5 1.5 5 4"></path>
        <circle cx="17" cy="8.5" r="2.5"></circle>
        <path d="M13.5 14.5c.7-1.8 2.7-2.8 4.5-2.8 1.5 0 3 .6 3.9 1.8"></path>
      </svg>
      <span class="font-medium">Manage VA's</span>
    </a>

    <!-- Customer Support -->
    <a href="{{ support_url }}"
       class="group flex items-center gap-3 rounded-lg px-3 py-2 transition
              {% if request.path == support_url %} bg-white/10 text-white {% else %} text-white/70 hover:text-white hover:bg-white/5 {% endif %}"
       aria-current="{% if request.path == support_url %}page{% else %}false{% endif %}">
      <svg class="h-4 w-4 opacity-80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M5 18l3-3h9a3 3 0 0 0 3-3V7a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v11z"></path>
        <path d="M8 9h8M8 12h5"></path>
      </svg>
      <span class="font-medium">Customer Support</span>
    </a>

    <!-- Product Research (toggle reveals choice panel) -->
    <div class="relative">
      <button id="product-research-toggle"
              class="group flex w-full items-center gap-3 rounded-lg px-3 py-2 transition
                     {% if request.path == single_url or request.path == bulk_url %} bg-white/10 text-white {% else %} text-white/70 hover:text-white hover:bg-white/5 {% endif %}"
              aria-expanded="false"
              aria-controls="product-research-panel"
              type="button">
        <svg class="h-4 w-4 opacity-80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="11" cy="11" r="5.5"></circle>
          <path d="M20 20l-4.5-4.5"></path>
        </svg>
        <span class="font-medium">Product Research</span>
        <svg class="ml-auto h-4 w-4 opacity-70" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path d="M5.23 7.21a.75.75 0 0 1 1.06-.02L10 10.67l3.71-3.48a.75.75 0 0 1 1.04 1.08l-4.23 3.97a1 1 0 0 1-1.38 0L5.25 8.27a.75.75 0 0 1-.02-1.06Z"/>
        </svg>
      </button>

      <!-- Choice panel -->
      <div id="product-research-panel" class="mt-2 hidden rounded-xl bg-neutral-900 ring-1 ring-white/20 shadow-xl">
        <a href="{{ single_url }}" class="flex items-start gap-3 p-3 rounded-lg hover:bg-white/5 transition">
          <svg class="h-4 w-4 opacity-80 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <circle cx="11" cy="11" r="5.5"></circle>
            <path d="M20 20l-4.5-4.5"></path>
          </svg>
          <div class="flex-1">
            <div class="text-sm font-medium">Single search</div>
            <p class="mt-1 text-xs text-white/70">
              Single search is made so you can research one specific product more deeply, but looking at all its stats in one place
            </p>
          </div>
        </a>
        <div class="border-t border-white/10"></div>
        <a href="{{ bulk_url }}" class="flex items-start gap-3 p-3 rounded-lg hover:bg-white/5 transition">
          <svg class="h-4 w-4 opacity-80 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="3" y="3" width="7" height="7" rx="2"></rect>
            <rect x="14" y="3" width="7" height="7" rx="2"></rect>
            <rect x="3" y="14" width="7" height="7" rx="2"></rect>
            <rect x="14" y="14" width="7" height="7" rx="2"></rect>
          </svg>
          <div class="flex-1">
            <div class="text-sm font-medium">Bulk product search</div>
            <p class="mt-1 text-xs text-white/70">
              Bulk product research is a way to go through hundereds of products and find the best ones in 2 clicks
            </p>
          </div>
        </a>
      </div>
    </div>

    <!-- Keyword Analysis -->
    <a href="{{ keywords_url }}"
       class="group flex items-center gap-3 rounded-lg px-3 py-2 transition
              {% if request.path == keywords_url %} bg-white/10 text-white {% else %} text-white/70 hover:text-white hover:bg-white/5 {% endif %}"
       aria-current="{% if request.path == keywords_url %}page{% else %}false{% endif %}">
      <svg class="h-4 w-4 opacity-80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M3 16l6-6 4 4 8-8"></path>
        <path d="M21 21H3V3"></path>
      </svg>
      <span class="font-medium">Keyword Analysis</span>
    </a>

    <!-- Settings -->
    <a href="{{ settings_url }}"
       class="group flex items-center gap-3 rounded-lg px-3 py-2 transition
              {% if request.path == settings_url %} bg-white/10 text-white {% else %} text-white/70 hover:text-white hover:bg-white/5 {% endif %}"
       aria-current="{% if request.path == settings_url %}page{% else %}false{% endif %}">
      <svg class="h-4 w-4 opacity-80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M4 6h16M10 6v8"></path>
        <path d="M4 12h16M14 12v6"></path>
        <path d="M4 18h16M6 18v-4"></path>
      </svg>
      <span class="font-medium">Settings</span>
    </a>
  </nav>

  <!-- Bottom actions -->
  <div class="px-3 pb-4 space-y-3 sticky bottom-0 bg-[var(--surface-1)]">
    <!-- Quick keyword search trigger (new) -->
    <button id="qks-toggle" class="w-full inline-flex items-center justify-between rounded-lg px-3 py-2 text-xs ring-1 ring-white/20 hover:ring-white transition">
      <span>Quick keyword search</span>
      <svg class="h-4 w-4 opacity-70" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
        <path d="M13.78 12.72a7 7 0 1 0-1.06 1.06l3.49 3.49a.75.75 0 1 0 1.06-1.06l-3.49-3.49ZM14 8a6 6 0 1 1-12 0 6 6 0 0 1 12 0Z"/>
      </svg>
    </button>

    <!-- Theme toggle -->
    <div class="flex items-center justify-between rounded-lg px-3 py-2 text-xs ring-1 ring-[var(--border)]">
      <span class="text-white/70">Theme</span>
      <button id="theme-toggle" class="inline-flex items-center gap-2 rounded-md px-2 py-1 ring-1 ring-white/20 hover:ring-white transition">
        <svg id="theme-icon" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M12 3a9 9 0 1 0 9 9c0-.34-.02-.67-.05-1A7 7 0 1 1 13 3c-.34-.03-.66-.05-1-.05Z"/>
        </svg>
        <span id="theme-label" class="font-medium">Dark</span>
      </button>
    </div>

    <a href="{% url 'logout' %}" class="w-full inline-flex items-center justify-center rounded-lg px-3 py-2 text-sm font-medium bg-[var(--surface-1)] text-[var(--text)] hover:bg-[var(--surface-2)] transition border border-[var(--border)]">
      Sign out
    </a>
  </div>
</aside>

<!-- Floating QKS panel -->
<div id="qks-panel" class="hidden fixed right-4 bottom-4 w-[28rem] max-w-[90vw] max-h-[70vh] overflow-hidden rounded-xl bg-neutral-900 ring-1 ring-white/20 shadow-2xl z-[1000]">
  <div class="px-4 py-3 border-b border-white/10 flex items-center justify-between">
    <h3 class="font-display text-base">Quick keyword search</h3>
    <button id="qks-close" class="rounded-md px-2 py-1 text-xs ring-1 ring-white/20 hover:ring-white transition">Close</button>
  </div>
  <div class="p-4">
    <form id="qks-form" class="flex items-center gap-2">
      <label for="qks-input" class="sr-only">Keyword</label>
      <!-- Updated: theme-aware background, text, border; removed dark-only classes -->
      <input id="qks-input" name="keyword" type="text" placeholder="e.g. vintage tote bag"
            autocomplete="off"
            class="flex-1 rounded-lg bg-[var(--surface-1)] px-3 py-2 text-sm text-[var(--text)] border border-[var(--border)] outline-none" />
      <!-- Updated: theme-aware button to avoid dark-only white background -->
      <button id="qks-search-btn" type="submit"
              class="inline-flex items-center gap-2 rounded-lg px-3 py-2 text-sm font-medium bg-[var(--surface-2)] text-[var(--text)] hover:bg-[var(--surface-1)] transition border border-[var(--border)]">
        <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="M13.78 12.72a7 7 0 1 0-1.06 1.06l3.49 3.49a.75.75 0 1 0 1.06-1.06l-3.49-3.49ZM14 8a6 6 0 1 1-12 0 6 6 0 0 1 12 0Z"/></svg>
        Search
      </button>
    </form>
    <div id="qks-status" class="mt-2 text-xs text-white/70"></div>

    <div id="qks-mini-metrics" class="mt-3 grid grid-cols-3 gap-3"></div>

    <div id="qks-chart-wrap" class="mt-3 rounded-lg ring-1 ring-white/10 p-2">
      <canvas id="qks-chart" aria-label="Keyword trend" height="140"></canvas>
      <div id="qks-no-trend" class="hidden text-xs text-white/60">No trend data available.</div>
    </div>
  </div>
</div>

<!-- Global theme overrides; loaded with sidebar include -->
<style>
  /* QKS input/button theme alignment */
  #qks-input {
    background-color: var(--surface-1) !important;
    color: var(--text) !important;
    border: 1px solid var(--border) !important;
  }
  #qks-input::placeholder { color: var(--muted) !important; }
  #qks-input:focus {
    outline: none !important;
    box-shadow: 0 0 0 2px var(--ring) !important;
    border-color: var(--ring) !important;
  }
  #qks-search-btn {
    background-color: var(--surface-2) !important;
    color: var(--text) !important;
    border: 1px solid var(--border) !important;
  }
  #qks-search-btn:hover { background-color: var(--surface-1) !important; }

  /* Black/White theme tokens */
  html { color-scheme: dark; --bg:#000; --surface-1:#0a0a0a; --surface-2:#121212; --text:#fff; --muted:rgba(255,255,255,0.70); --border:rgba(255,255,255,0.12); --ring:rgba(255,255,255,0.22); }
  html[data-theme="light"] { color-scheme: light; --bg:#fff; --surface-1:#fff; --surface-2:#f5f5f5; --text:#000; --muted:rgba(0,0,0,0.70); --border:rgba(0,0,0,0.12); --ring:rgba(0,0,0,0.22); }

  /* Map common classes to tokens for both modes */
  html[data-theme="dark"] .bg-white,
  html[data-theme="dark"] .bg-neutral-50,
  html[data-theme="dark"] .bg-neutral-100 { background-color: var(--surface-1) !important; }
  html[data-theme="dark"] .hover\:bg-neutral-50:hover,
  html[data-theme="dark"] .hover\:bg-white\/5:hover { background-color: var(--surface-2) !important; }

  html[data-theme="light"] .bg-black,
  html[data-theme="light"] .bg-black\/80,
  html[data-theme="light"] .bg-neutral-900,
  html[data-theme="light"] .bg-neutral-950 { background-color: var(--surface-1) !important; }

  /* Text mappings */
  html[data-theme="dark"] .text-black { color: var(--text) !important; }
  html[data-theme="light"] .text-white,
  html[data-theme="light"] .text-white\/70,
  html[data-theme="light"] .text-white\/60,
  html[data-theme="light"] .text-white\/50 { color: var(--text) !important; }

  /* Border and ring mappings */
  [data-theme] .border-neutral-200,
  [data-theme] .border-neutral-300 { border-color: var(--border) !important; }
  [data-theme] .ring-white\/10,
  [data-theme] .ring-white\/20 { --tw-ring-color: var(--ring) !important; }

  /* QKS mini metric cards */
  #qks-mini-metrics .card {
    border-radius: 0.75rem;
    padding: 0.6rem 0.8rem;
    border: 1px solid var(--border);
    background: var(--surface-2);
  }
  #qks-mini-metrics .value { font-weight: 600; }
  #qks-mini-metrics .sub { font-size: 0.75rem; opacity: 0.7; }
</style>

<script>
  // Provide URLs for QKS API
  window.QUICK_KEYWORD_SEARCH_URL = "{% url 'quick_keyword_search' %}";
  window.QUICK_KEYWORD_LAST_URL = "{% url 'quick_keyword_last' %}";

  (function(){
    var root = document.documentElement;
    var key = 'eto_theme';
    var btn = document.getElementById('theme-toggle');
    var label = document.getElementById('theme-label');
    var icon = document.getElementById('theme-icon');

    function applyTheme(t) {
      root.setAttribute('data-theme', t);
      if (label) label.textContent = (t === 'light') ? 'Light' : 'Dark';
      if (icon) { icon.style.opacity = t === 'light' ? '0.9' : '0.9'; }
    }

    var saved = localStorage.getItem(key) || 'dark';
    applyTheme(saved);

    if (btn) {
      btn.addEventListener('click', function(){
        var next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        localStorage.setItem(key, next);
        applyTheme(next);
      });
    }

    // Product Research choice panel toggle
    var prToggle = document.getElementById('product-research-toggle');
    var prPanel = document.getElementById('product-research-panel');
    if (prToggle && prPanel) {
      prToggle.addEventListener('click', function(e){
        e.preventDefault();
        var isOpen = !prPanel.classList.contains('hidden');
        prPanel.classList.toggle('hidden');
        prToggle.setAttribute('aria-expanded', String(!isOpen));
      });
      document.addEventListener('click', function(e){
        if (!prPanel.classList.contains('hidden')) {
          var inside = prPanel.contains(e.target) || prToggle.contains(e.target);
          if (!inside) {
            prPanel.classList.add('hidden');
            prToggle.setAttribute('aria-expanded','false');
          }
        }
      });
    }

    // Quick Keyword Search (QKS)
    var qksToggle = document.getElementById('qks-toggle');
    var qksPanel = document.getElementById('qks-panel');
    var qksClose = document.getElementById('qks-close');
    var qksForm = document.getElementById('qks-form');
    var qksInput = document.getElementById('qks-input');
    var qksStatus = document.getElementById('qks-status');
    var qksMetrics = document.getElementById('qks-mini-metrics');
    var qksChartWrap = document.getElementById('qks-chart-wrap');
    var qksNoTrend = document.getElementById('qks-no-trend');
    var qksCanvas = document.getElementById('qks-chart');
    var chartRef = null;

    function getCookie(name) {
      var cookies = document.cookie ? document.cookie.split('; ') : [];
      for (var i = 0; i < cookies.length; i++) {
        var parts = cookies[i].split('=');
        var key = decodeURIComponent(parts[0]);
        var val = parts.slice(1).join('=');
        if (key === name) return decodeURIComponent(val);
      }
      return '';
    }
    function csrfHeader() {
      var token = getCookie('csrftoken');
      return token ? { 'X-CSRFToken': token } : {};
    }
    function ensureChartJs() {
      return new Promise(function(resolve){
        if (window.Chart) { resolve(); return; }
        var s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        s.async = true;
        s.onload = function(){ resolve(); };
        s.onerror = function(){ resolve(); };
        document.head.appendChild(s);
      });
    }
    function setStatus(msg, tone) {
      qksStatus.textContent = msg || '';
      qksStatus.className = 'mt-2 text-xs ' + (tone === 'error' ? 'text-red-400' : 'text-white/70');
    }
    function saveLocal(keyword, result) {
      try { localStorage.setItem('eto_qks_last', JSON.stringify({ keyword: keyword, result: result, ts: Date.now() })); } catch (_) {}
    }
    function loadLocal() {
      try { var raw = localStorage.getItem('eto_qks_last'); return raw ? JSON.parse(raw) : null; } catch(_) { return null; }
    }
    function normalizePayload(body) {
      var normalized = (body && body.data) || (body && body.result) || body;
      return normalized;
    }
    function classifyCompetition(v) {
      if (v == null || isNaN(v)) return '—';
      var n = Number(v);
      var score = n > 1 ? Math.max(0, Math.min(100, n)) : Math.round(n * 100);
      if (score < 35) return 'Low';
      if (score < 65) return 'Medium';
      return 'High';
    }
    function extractCompetition(res) {
      var listings = (res && res.avgTotalListings) || (res && res.data && res.data.avgTotalListings);
      if (listings !== undefined && listings !== null && !isNaN(Number(listings))) {
        var n = Number(listings);
        var min = 10000, max = 3000000;
        var score = ((n - min) / (max - min)) * 100;
        score = Math.max(0, Math.min(100, score));
        return Math.round(score);
      }
      var cands = [
        res && res.competition,
        res && res.data && res.data.competition,
        res && res.metrics && res.metrics.competition,
        res && res.summary && res.summary.competition_score,
        res && res.metrics && res.metrics.competitionScore,
        res && res.result && res.result.metrics && res.result.metrics.competition,
        res && res.result && res.result.metrics && res.result.metrics.competitionScore,
        res && res.summary && res.summary.competitionScore
      ];
      for (var i = 0; i < cands.length; i++) {
        var c = cands[i];
        if (c !== undefined && c !== null && !isNaN(Number(c))) return Number(c);
      }
      return null;
    }
    function extractVolume(res) {
      var cands = [
        res && res.searchVolume,
        res && res.volume,
        res && res.search_volume,
        res && res.data && res.data.volume,
        res && res.metrics && res.metrics.volume,
        res && res.summary && res.summary.avg_monthly_searches,
        res && res.metrics && res.metrics.searchVolume,
        res && res.summary && res.summary.monthly_searches
      ];
      for (var i = 0; i < cands.length; i++) {
        var c = cands[i];
        if (c !== undefined && c !== null && !isNaN(Number(c))) return Number(c);
      }
      return null;
    }
    function extractTrend(res) {
      var series = null;
      if (Array.isArray(res && res.dailyStats)) series = res.dailyStats;
      else if (Array.isArray(res && res.trend)) series = res.trend;
      else if (Array.isArray(res && res.data && res.data.trend)) series = res.data.trend;
      else if (Array.isArray(res && res.result && res.result.trend)) series = res.result.trend;
      else if (Array.isArray(res && res.history)) series = res.history;
      else if (Array.isArray(res && res.time_series)) series = res.time_series;
      else if (Array.isArray(res && res.timeseries)) series = res.timeseries;
      else if (Array.isArray(res && res.metrics && res.metrics.monthly)) series = res.metrics.monthly;
      if (!Array.isArray(series) || !series.length) return null;

      var labels = [], values = [];
      for (var i = 0; i < series.length; i++) {
        var item = series[i];
        if (typeof item === 'number') { values.push(item); labels.push(''); }
        else if (item && typeof item === 'object') {
          if ('date' in item && 'searchVolume' in item) { labels.push(String(item.date)); values.push(Number(item.searchVolume)); }
          else if ('month' in item && 'value' in item) { labels.push(String(item.month)); values.push(Number(item.value)); }
          else if ('date' in item && 'count' in item) { labels.push(String(item.date)); values.push(Number(item.count)); }
          else {
            var v = Number(Object.values(item).find(function(x){ return !isNaN(Number(x)); }));
            values.push(isNaN(v) ? 0 : v); labels.push('');
          }
        }
      }
      return { labels: labels, values: values };
    }
    function themeTokens() {
      var isLight = root.getAttribute('data-theme') === 'light';
      var gridDefault = isLight ? 'rgba(0,0,0,0.10)' : 'rgba(255,255,255,0.08)';
      var ticksDefault = isLight ? 'rgba(0,0,0,0.65)' : 'rgba(255,255,255,0.7)';
      var lineColor = isLight ? '#0a0a0a' : '#ffffff';
      return { grid: gridDefault, ticks: ticksDefault, line: lineColor };
    }
    function renderMiniMetrics(keyword, res) {
      var comp = extractCompetition(res);
      var vol = extractVolume(res);
      var listings = (res && res.avgTotalListings) || (res && res.data && res.data.avgTotalListings);
      var compScore = comp == null ? '—' : (comp > 1 ? Math.round(comp) : Math.round(comp * 100));
      var compLevel = classifyCompetition(comp);
      var volText = vol == null ? '—' : new Intl.NumberFormat().format(Math.round(vol));
      var listingsText = (listings !== undefined && listings !== null && !isNaN(Number(listings)))
        ? new Intl.NumberFormat().format(Number(listings))
        : null;

      qksMetrics.innerHTML = `
        <div class="card">
          <div class="text-xs text-white/70">Keyword</div>
          <div class="value text-lg mt-1">${keyword}</div>
        </div>
        <div class="card">
          <div class="text-xs text-white/70">Competition</div>
          <div class="value text-lg mt-1">${compScore}${comp == null ? '' : (comp > 1 ? '' : '%')}</div>
          <div class="sub mt-1">${compLevel}${listingsText ? ' • ' + listingsText + ' listings' : ''}</div>
        </div>
        <div class="card">
          <div class="text-xs text-white/70">Volume</div>
          <div class="value text-lg mt-1">${volText}</div>
          <div class="sub mt-1">Avg monthly searches</div>
        </div>
      `;
    }
    function renderMiniChart(trend) {
      if (!trend) {
    qksNoTrend.classList.remove('hidden');
    if (chartRef) { try { chartRef.destroy(); } catch(_){} chartRef = null; }
    return;
  }
  qksNoTrend.classList.add('hidden');
  ensureChartJs().then(function(){
    try {
      if (chartRef) chartRef.destroy();
    } catch(_) {}
    var t = themeTokens();
    var isLight = root.getAttribute('data-theme') === 'light';
    var tooltipBg = isLight ? 'rgba(255,255,255,0.95)' : 'rgba(20,20,20,0.95)';
    var tooltipText = isLight ? '#0a0a0a' : '#ffffff';
    var tooltipBorder = isLight ? 'rgba(0,0,0,0.15)' : 'rgba(255,255,255,0.15)';

    chartRef = new Chart(qksCanvas.getContext('2d'), {
      type: 'line',
      data: {
        labels: trend.labels,
        datasets: [{
          label: 'Trend',
          data: trend.values,
          borderColor: t.line,
          backgroundColor: 'transparent',
          borderWidth: 1.5,
          tension: 0.3,
          pointRadius: 0,
          pointHitRadius: 12,
          pointHoverRadius: 5
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        onHover: function(evt, elements) {
          qksCanvas.style.cursor = elements.length ? 'crosshair' : 'default';
        },
        scales: {
          x: { grid: { color: t.grid }, ticks: { color: t.ticks, font: { size: 10 } } },
          y: { grid: { color: t.grid }, ticks: { color: t.ticks, font: { size: 10 } } }
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            displayColors: false,
            backgroundColor: tooltipBg,
            borderColor: tooltipBorder,
            borderWidth: 1,
            titleColor: tooltipText,
            bodyColor: tooltipText,
            padding: 8,
            callbacks: {
              title: function(items) { return items && items[0] ? String(items[0].label || '') : ''; },
              label: function(ctx) {
                var v = ctx.parsed.y;
                var num = Number(v);
                var formatted = isNaN(num) ? String(v) : new Intl.NumberFormat().format(num);
                return 'Value: ' + formatted;
              }
            }
          }
        }
      }
    });
  });
    }

    function openQks() {
      qksPanel.classList.remove('hidden');
      // Load last from server, then fallback to localStorage
      fetch(window.QUICK_KEYWORD_LAST_URL, { credentials: 'same-origin' })
        .then(function(r){ return r.json().catch(function(){ return {}; }).then(function(b){ return { ok: r.ok, body: b }; }); })
        .then(function(resp){
          var last = (resp.ok && resp.body && resp.body.last) || null;
          var payload = last && last.result ? last.result : null;
          var body = payload && payload.body ? payload.body : payload;
          var normalized = normalizePayload(body);
          if (last && last.keyword) qksInput.value = last.keyword;
          if (normalized) {
            renderMiniMetrics(qksInput.value || '', normalized);
            renderMiniChart(extractTrend(normalized));
            setStatus('Loaded last quick search.', 'success');
            saveLocal(last.keyword, payload);
          } else {
            var local = loadLocal();
            if (local && local.result) {
              var nb = normalizePayload(local.result.body || local.result);
              if (local.keyword) qksInput.value = local.keyword;
              renderMiniMetrics(qksInput.value || '', nb);
              renderMiniChart(extractTrend(nb));
            } else {
              setStatus('Enter a keyword and press Search.', 'success');
            }
          }
        })
        .catch(function(){ setStatus('Enter a keyword and press Search.', 'success'); });
    }
    function closeQks() {
    qksPanel.classList.add('hidden');
  }

  if (qksToggle) qksToggle.addEventListener('click', function(e){ e.preventDefault(); openQks(); });
  if (qksClose) qksClose.addEventListener('click', function(e){ e.preventDefault(); closeQks(); });

  if (qksForm) {
    qksForm.addEventListener('submit', function(e){
      e.preventDefault();
      var kw = (qksInput.value || '').trim();
      if (!kw) { setStatus('Please enter a keyword.', 'error'); return; }
      setStatus('Searching…', 'success');
      fetch(window.QUICK_KEYWORD_SEARCH_URL, {
        method: 'POST',
        headers: Object.assign({ 'Accept': 'application/json', 'Content-Type': 'application/json' }, csrfHeader()),
        credentials: 'same-origin',
        body: JSON.stringify({ keyword: kw })
      })
      .then(function(r){ return r.json().catch(function(){ return {}; }).then(function(b){ return { ok: r.ok, status: r.status, body: b }; }); })
      .then(function(resp){
        if (!resp.ok) { setStatus('Search failed (' + resp.status + ').', 'error'); return; }
        var body = resp.body && resp.body.body ? resp.body.body : resp.body;
        var normalized = normalizePayload(body);
        renderMiniMetrics(kw, normalized);
        renderMiniChart(extractTrend(normalized));
        setStatus('Done.', 'success');
        try { saveLocal(kw, resp.body); } catch(_) {}
      })
      .catch(function(err){
        setStatus('Search failed: ' + (err && err.message ? err.message : 'unknown error'), 'error');
      });
    });
  }

  // Keep panel on screen unless explicitly closed
  document.addEventListener('click', function(e){});
  
  })();
</script>